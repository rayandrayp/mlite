<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="{if: $page.desc}{$page.desc}{else}{$settings.description}{/if}">
    <title>{$title} - {$settings.nama_instansi}</title>
    <link rel="icon" href="{{?=url()?}/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="{?=url()?}/assets/css/bootstrap.min.css">
    <link href="{?=url()?}/assets/css/font-awesome.css" rel="stylesheet">
    <script src="{?=url()?}/assets/jscripts/jquery.min.js"></script>
    <script src="{?=url()?}/assets/jscripts/bootstrap.min.js"></script>
    <style media="screen">
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            color: #fff;
            background: #0264d6;
            height: calc(100vh);
            width: 100%;
        }
        
        .antrian_judul {
            font-size: 56px;
            padding-bottom: 20px;
        }
        
        .loket {
            padding: 0;
        }
        
        .loket a {
            text-decoration: none;
        }
        
        .kiri {
            float: left;
            width: 67%;
            padding: 10px;
        }
        
        .kanan {
            float: right;
            width: 33%;
            padding: 10px;
        }
        
        .panel-body .no_antrian {
            font-size: 170px;
            font-weight: lighter;
            padding: 0;
            margin-top: -45px;
            margin-bottom: -45px;
        }
        
        .panel-footer .no_loket {
            font-size: 30px;
            font-weight: bold;
            color: #000;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .panel-body .date {
            font-size: 21px;
            color: #FF0000;
            font-weight: lighter;
            padding-top: 5px;
            padding-bottom: 5px;
            margin-top: -20px;
            margin-bottom: -25px;
        }
        
        .panel-footer .clock {
            font-size: 20px;
            color: #000;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .panel-title.marquee {
            font-size: 36px;
            padding-top: 10px;
            padding-bottom: 0px;
            margin-top: 10px;
            margin-bottom: 10px;
            color: #FF0000;
            background-color: #fff;
        }
        
        footer {
            position: fixed;
            right: 0px;
            bottom: 0px;
            height: 40px;
            width: calc(100% - 0px);
            font-size: 14px;
            color: #fff;
        }
        
        footer a,
        footer a:hover {
            color: #fff;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: auto;
            grid-template-rows: auto auto;
            grid-gap: 10px;
            /* background-color: #2196F3; */
            padding: 10px;
        }
        
        .grid-container>div {
            background-color: rgba(255, 255, 255, 0.8);
            /* text-align: center; */
            padding: 20px 0;
            /* font-size: 30px; */
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        {if: !$show}
        <h2 class="text-center text-white antrian_judul"><img class="logo" src="{?=url()?}/{$logo}" alt="" width="60px"> Antrian Loket {$settings.nama_instansi}</h2>
        <div class="row loket">
            <div class="kiri">
                <div class="card bg-dark text-white">
                    <div class="embed-responsive embed-responsive-16by9">
                        <iframe class="embed-responsive-item"
                            src="https://www.youtube.com/embed/videoseries?list=PL6JppWl-2ahmaw8u12sJ6gtsilqR07TYV&rel=0&modestbranding=1&autohide=1&mute=0&showinfo=0&controls=1&loop=1&autoplay=1"
                            allowfullscreen></iframe>
                            <!-- <iframe class="embed-responsive-item"
                            src="https://www.youtube.com/embed/{$vidio}?rel=0&modestbranding=1&autohide=1&mute=0&showinfo=0&controls=1&loop=1&autoplay=1&playlist={$vidio}"
                            allowfullscreen></iframe> -->
                        </div>
                </div>
            </div>
            <div class="kanan">
                <div class="panel border-success" style="grid-auto-flow: row dense;">
                    <div class="panel-body text-success">
                        <div class="date">
                            <script type='text/javascript'>
                                var months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                                var myDays = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jum&#39;at', 'Sabtu'];
                                var date = new Date();
                                var day = date.getDate();
                                var month = date.getMonth();
                                var thisDay = date.getDay(),
                                    thisDay = myDays[thisDay];
                                var yy = date.getYear();
                                var year = (yy < 1000) ? yy + 1900 : yy;
                                document.write(thisDay + ', ' + day + ' ' + months[month] + ' ' + year);
                            </script>
                        </div>
                    </div>
                    <div class="panel-footer border-success" style="background-color:#ffcc00; height: 40px;">
                        <div class="clock"><span id="clock"><span></div>
          </div>
        </div>
        <div class="grid-container" style="grid-auto-flow: row dense;">
          <a href="{?=url()?}/anjungan/farmasi?show=panggil_obat" target="_blank">
            <div class="panel border-success">
              <div class="panel-body text-success" style="height: 180px;">
                <div class="no_antrian">A <span class="antrian_obat"><span></div>
              </div>
              <div class="panel-footer bg-transparent border-success" style="height: 75px;">
                <div class="no_loket">Loket Pengambilan Obat<span class="get_loket"><span></div>
              </div>
            </div>
          </a>
        </div>
        <div class="grid-container" style="grid-auto-flow: row dense;">
          <a href="{?=url()?}/anjungan/farmasi?show=panggil_racikan" target="_blank">
            <div class="panel border-success">
              <div class="panel-body text-success" style="height: 180px;">
                <div class="no_antrian">B <span class="antrian_racikan"><span></div>
              </div>
              <div class="panel-footer bg-transparent border-success" style="height: 75px;">
                <div class="no_loket">Loket Pengambilan Racikan<span class="get_loket"><span></div>
              </div>
            </div>
          </a>
        </div>
      </div>

    </div>
    <div class="row">
      <div class="panel-title marquee">
        <marquee>{$running_text}</marquee>
      </div>
    </div>
  </div>
  {/if}

  {if: $show == 'panggil_obat' || $show == 'panggil_racikan'}

  <div align="center" style="font-size: 64px;color:white; text-shadow: 2px 2px 4px #000000;margin:30px;"><img
      class="logo" src="{?=url()?}/{$logo}" alt="" width="80px"> Pemanggil Antrian Farmasi</div>
  <div class="container text-center">
    <div class="row">
      <div class="card-deck">
        <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4 mb-5 "></div>
        <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4 mb-5 ">
          <div class="panel" style="color:#000;">
            <div class="panel-heading" style="font-size:32px;">Loket {$namaloket}</div>
            <div class="panel-body">
              <h5 class="panel-title" style="font-size:72px;">{?=strtoupper($kodeloket)?}{$antrian}</h5>
            </div>
            <div class="panel-footer">
              <div class="btn-group btn-group-justified">
                <a href="#" class="btn btn-primary" style="font-size:32px;">
                  <p style="font-size:15px;">Total Antrean {$noantrian}</p>
                </a>
                <a href="#" class="btn btn-primary" style="font-size:32px;" id="panggilulang"
                  onclick="panggil({$antrian})">
                  <p style="font-size:15px;">Panggil <i class="fa fa-bullhorn"></i></p>
                </a>
              </div>
              <br>

              <div class="btn-group btn-group-justified">
                <a href="{?=url()?}/anjungan/farmasi?show={$panggil_loket}&loket={$namaloket}&lewati={$antrian}"
                  class="btn btn-warning" style="font-size:32px;">
                  <p style="font-size:15px;">Lewati <i class="fa fa-pause"></i></p>
                </a>
                <a href="{?=url()?}/anjungan/farmasi?show={$panggil_loket}&loket={$namaloket}&batal={$kodebooking}"
                  class="btn btn-danger" style="font-size:32px;">
                  <p style="font-size:15px;">Batal <i class="fa fa-times"></i></p>
                </a>
              </div>
              <br>

              <div class="row" style="padding-left: 15px; padding-right: 15px;">
                <!-- <form action="{?=url()?}/anjungan/farmasi?show={$panggil_loket}&loket={$namaloket}" method="GET"> -->
                <div class="input-group input-group-lg">
                  <input type="text" class="form-control form-control-lg" name="kdbooking" id="kdbooking"
                    placeholder="Kode Booking" disabled="true" value="{$kodebooking}">
                  <span class="input-group-btn" style="margin:30px">
                    <!-- Append button addon using class input-group-lg -->
                    {if: $antrian > $noantrian}
                    <a href="" class="btn btn-primary" disabled="disabled" style="font-size:32px;">
                      <p style="font-size:15px;">Selesai <i class="fa fa-forward"></i></p>
                    </a>
                    <!-- <input class="btn btn-primary" disabled="disabled" type="submit" value="Selesai &#9745"> -->
                    {else}
                    <a href="{?=url()?}/anjungan/farmasi?show={$panggil_loket}&loket={$namaloket}&kdbooking={$kodebooking}"
                      class="btn btn-primary" style="font-size:32px;">
                      <p style="font-size:15px;">Selesai <i class="fa fa-forward"></i></p>
                    </a>
                    <!-- <input  href="{?=url()?}/anjungan/farmasi?show={$panggil_loket}&loket={$namaloket}&kdbooking={$kodebooking}" class="btn btn-primary" type="submit" value="Selesai &#9745"> -->
                    {/if}
                    <!-- {if: $antrian > $noantrian}
                      <a  class="btn btn-primary" disabled="disabled"
                        style="font-size:32px;"><p style="font-size:15px;">Selesai <i class="fa fa-forward"></i></p></a>
                      {else}
                      <a href="{?=url()?}/anjungan/farmasi?show={$panggil_loket}&loket={$namaloket}" class="btn btn-primary"
                        style="font-size:32px;"><p style="font-size:15px;">Selesai <i class="fa fa-forward"></i></p></a>
                      {/if} -->
                  </span>
                        </div>
                        <!-- </form> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>
    <div class="text-center" style="width: 300px;margin: 20px auto;">
        <div class="form-row">
            <div class="form-group col-md-6">
                <label>Antrian Terlewati</label>
            </div>
            <div class="form-group col-md-6">
                <select id="antrianterlewati" name="antrianterlewati" class="form-control" style="width: 150px;">
          {loop: $antrianterlewati}
          <option value="{$value.noantrian}">{$value.noantrian}</option>
          {/loop}
        </select>
            </div>
        </div>
        <form action="">
            <input type="hidden" name="show" value="{$panggil_loket}">
            <input type="hidden" name="reset" value="{?=isset($_GET['loket'])?$_GET['loket']:'1'?}">
            <div class="row">
                <div class="col">
                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control form-control-lg" name="antrian" placeholder="Input Nomor Antrian" value="">
                        <span class="input-group-btn">
              <!-- Append button addon using class input-group-lg -->
              <button class="btn btn-danger" type="submit">Panggil</button>
            </span>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="container">
        <ul class="text-white">
            <li>Klik tombol <i class="fa fa-forward"></i> 1x untuk memanggil antrian selanjutnya</li>
            <li>Klik tombol <i class="fa fa-bullhorn"></i> 1x untuk memanggil ulang antrian</li>
            <li>Untuk menyesuaikan urutan, masukkan nomor urut pada kolom lompat dan klik tombol panggil 1x</li>
            <li>Angka di Sebelah Kiri Tombol Pemanggil Menunjukan Jumlah Nomor Antrian Yang Telah diambil Pasien</li>
        </ul>
    </div>
    {/if}

    <footer class="visible-lg visible-md bg-primary" style="padding:10px;z-index:1000;">
        <div class="canvas">
            <p class="pull-right">
                Made with <i class="fa fa-heart text-danger"></i> by <a href="https://basoro.id/" target="_blank"><b>drg. F.
            Basoro</b>.</a> {$powered}.
            </p>
            <p><i class="fa fa-fw fa-calendar"></i> <span>{$tanggal}</span> <i class="fa fa-fw fa-clock-o"></i><span id="clock"></span> <i class="fa fa-fw fa-user"></i> <span>{?= sprintf('Login sebagai <strong>%s</strong>',
          $username) ?}</span></p>
        </div>
    </footer>

    {if: !$show}
    <script type="text/javascript">
        function showTime() {
            var a_p = "";
            var today = new Date();
            var curr_hour = today.getHours();
            var curr_minute = today.getMinutes();
            var curr_second = today.getSeconds();
            if (curr_hour < 12) {
                a_p = "AM";
            } else {
                a_p = "PM";
            }
            if (curr_hour == 0) {
                curr_hour = 12;
            }
            if (curr_hour > 12) {
                curr_hour = curr_hour - 12;
            }
            curr_hour = checkTime(curr_hour);
            curr_minute = checkTime(curr_minute);
            curr_second = checkTime(curr_second);
            document.getElementById('clock').innerHTML = curr_hour + ":" + curr_minute + ":" + curr_second + " " + a_p;
        }

        function checkTime(i) {
            if (i < 10) {
                i = "0" + i;
            }
            return i;
        }
        setInterval(showTime, 500);

        $(document).ready(function() {
            // setInterval(function () {
            //   getAntrian();
            //   console.log("this")
            // }, 3000);
            setTimeout(function() {
                getAntrian();
            }, 3000);
        });

        function getAntrian() {
            $.ajax({
                url: '{?=url()?}/anjungan/panggilantrianfarmasi',
                dataType: 'json',
                success: function(data) {
                    if (data.status == false) {
                        setTimeout(function() {
                            getAntrian();
                        }, 3000);
                    } else {
                        for (const element of data.data_loket) {
                            fungsiloop(element);
                        }
                        //updateLayar(data.type, data.noantrian, data.loket);
                        console.log("data panggil " + data.panggil);
                        panggil(data.panggil);
                        console.log("data selesai " + data.data_loket[0]["kd"]);
                        setSelesai(data.data_loket[0]["kd"]);
                    }
                },
                error: function(xhr) {
                    console.log('An error occured.');
                    console.log(xhr.status);
                    setTimeout(function() {
                        getAntrian();
                    }, 3000);
                }
            });
        }

        function fungsiloop(value) {
            var type = value.type.split("#");
            console.log("Tipe " + type[0]);
            updateLayar(type[0], value.noantrian, value.loket);
        }

        function updateLayar(type, nomor, no_loket) {
            $('.antrian_' + type.toLowerCase()).html(nomor);
            // $('.get_' + type.toLowerCase()).html(loket);
        }

        function panggil(data) {
            var ass = new Array();
            console.log("begin panggil");
            $.each(data, function(key, value) {
                var filename = "{?=url()?}/plugins/anjungan/suara/" + value + ".wav";
                var auau = new Audio(filename);
                ass.push(auau);
            });

            console.log("data ass " + ass);
            play_sound_queue(ass);
        }

        function play(audio, callback) {
            var akhir = true;

            audio.playbackRate = 1.0;

            const playPromise = audio.play();
            //if (playPromise !== null){
            //    playPromise.catch(() => { media.play(); })
            //}

            if (callback) {
                //When the audio object completes it's playback, call the callback
                //provided
                audio.addEventListener('ended', callback);
                var akhir = false;
            }

            if (akhir == true) {
                audio.addEventListener('ended', function() {
                    getAntrian();
                });
            }
        }

        //Changed the name to better reflect the functionality
        function play_sound_queue(sounds) {
            var index = 0;

            function recursive_play() {
                //If the index is the last of the table, play the sound
                //without running a callback after
                if (index + 1 === sounds.length) {
                    play(sounds[index], null);
                } else {
                    //Else, play the sound, and when the playing is complete
                    //increment index by one and play the sound in the
                    //indexth position of the array
                    play(sounds[index], function() {
                        index++;
                        recursive_play();
                    });
                }
            }
            //Call the recursive_play for the first time
            recursive_play();
        }

        function setSelesai(id) {
            console.log("Set selesai ID=" + id);
            $.ajax({
                url: '{?=url()?}/anjungan/panggilselesai',
                dataType: 'json',
                data: {
                    id: id
                },
                error: function(xhr) {
                    console.log(xhr.status);
                }
            });

        }
    </script>
    {/if} 
    {if: $show == 'panggil_obat'}
    <script type="text/javascript">
        function panggil(noantrian) {
            var loket = '';
            var type = 'Obat'; 
            {if: isset($_GET['loket']) && $_GET['loket'] != ''}
              var loket = "{?=$_GET['loket']?}"; 
            {/if}

            console.log("type " + type);
            //alert('Panggil ' + loket + ' - ' + noantrian);
            $.ajax({
                type: "GET",
                url: '{?=url()?}/anjungan/setpanggil',
                dataType: 'json',
                data: {
                    noantrian: noantrian,
                    type: type, //'{?=str_replace("panggil_","",$_GET['show'])?}',
                    loket: loket
                },
                success: function(data) {
                    console.log(data);
                },
                error: function(xhr) {
                    console.log(xhr.status);
                }
            });
        }
    </script>
    {/if} 
    {if: $show == 'panggil_racikan'}
    <script type="text/javascript">
        function panggil(noantrian) {
            var loket = '';
            var type = 'Racikan'; 
            {if: isset($_GET['loket']) && $_GET['loket'] != ''}
                var loket = "{?=$_GET['loket']?}";
            {/if}

            console.log("type " + type);
            //alert('Panggil ' + loket + ' - ' + noantrian);
            $.ajax({
                type: "GET",
                url: '{?=url()?}/anjungan/setpanggil',
                dataType: 'json',
                data: {
                    noantrian: noantrian,
                    type: type, //'{?=str_replace("panggil_","",$_GET['show'])?}',
                    loket: loket
                },
                success: function(data) {
                    console.log(data);
                },
                error: function(xhr) {
                    console.log(xhr.status);
                }
            });
        }
    </script>
    {/if}
</body>

</html>